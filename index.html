<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Diplomas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="fonts/ffnort/stylesheet.css">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" onerror="libError('xlsx')"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="libError('jsPDF')"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" onerror="libError('html2canvas')"></script>
</head>
<body>
  <main class="container">
    <h1>Generador de Diplomas</h1>

    <div class="controls">
      <label class="file-input">
        <span>Seleccionar archivo Excel</span>
        <input type="file" id="file-input" accept=".xlsx,.xls,.csv">
      </label>
      <div class="info"><span id="count">0</span> participantes cargados</div>
      <select id="row-select"></select>
      <button id="preview-btn">Previsualizar</button>
      <button id="pdf-btn">Generar PDF del seleccionado</button>
      <button id="all-btn">Generar TODOS</button>
      <div id="status" class="status"></div>
    </div>

    <div id="preview">
      <section id="diploma" class="diploma">
        <div class="left-bar">
          <div class="left-text">
            <span class="big">DIPLOMA</span>
            <span class="small">De Participación</span>
          </div>
        </div>
        <div class="top-logos">
          <img src="PACIFICO SEGURO LOGO.png" alt="Pacífico Seguro" class="logo-pacifico">
          <img src="sello crea+.PNG" alt="Crea+" class="logo-crea">
        </div>
        <div class="content">
          <p class="intro">Crea+ felicita a:</p>
          <div class="name-container">
            <h3 id="nombre" class="name"></h3>
            <div class="name-underline"></div>
          </div>
          <p class="taller-text">Por su participación en el taller <span id="taller"></span> facilitado por <span id="facilitador"></span>.</p>
          <div class="signatures">
            <div class="signature">
              <img src="Firma diego.PNG" alt="Firma Diego" class="firma-img">
              <div class="firma-line"></div>
              <p class="firma-name">Diego [Nombre]</p>
              <p class="firma-role">Cargo 1</p>
            </div>
            <div class="signature">
              <img src="Firma 2.PNG" alt="Firma 2" class="firma-img">
              <div class="firma-line"></div>
              <p class="firma-name">Nombre 2</p>
              <p class="firma-role">Cargo 2</p>
            </div>
          </div>
          <p class="note">Este diploma es válido solo con la firma de los responsables y el sello de Crea+.</p>
        </div>
      </section>
    </div>
  </main>

<script>
function libError(name){
  document.getElementById('status').textContent = 'No se pudo cargar '+name+'. Revisa tu conexión a Internet.';
}

let participants=[];
let selectedIndex=0;

document.getElementById('file-input').addEventListener('change', e=>loadExcel(e.target.files[0]));
document.getElementById('preview-btn').addEventListener('click',()=>{
  selectedIndex = parseInt(document.getElementById('row-select').value)||0;
  renderDiploma(participants[selectedIndex]);
});
document.getElementById('pdf-btn').addEventListener('click',()=>{
  const data = participants[selectedIndex];
  if(data) downloadPDF(data);
});
document.getElementById('all-btn').addEventListener('click', downloadAll);

/**
 * Lee el archivo Excel y carga los participantes.
 */
async function loadExcel(file){
  if(!file){return;}
  if(file.size > 10*1024*1024){
    alert('El archivo supera 10MB');
    return;
  }
  const data = await file.arrayBuffer();
  const workbook = XLSX.read(data,{type:'array'});
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet,{defval:''});
  if(!rows.length){
    alert('El archivo Excel no contiene datos válidos');
    return;
  }
  const firstRow = rows[0];
  const map={};
  Object.keys(firstRow).forEach(k=>{map[k.toLowerCase()]=k;});
  if(!map['nombre']){
    alert('La columna "Nombre" es obligatoria');
    return;
  }
  participants = rows.map(r=>{
    const row={};
    for(const key in r){row[key.toLowerCase()] = r[key];}
    const nombre=row['nombre'];
    if(!nombre) return null;
    return {
      nombre:nombre,
      taller:row['taller']||'—',
      facilitador:row['facilitador']||'—'
    };
  }).filter(Boolean);
  document.getElementById('count').textContent=participants.length;
  const select=document.getElementById('row-select');
  select.innerHTML=participants.map((p,i)=>`<option value="${i}">${i+1} - ${p.nombre}</option>`).join('');
  selectedIndex=0;
  renderDiploma(participants[0]);
}

/**
 * Renderiza el diploma en pantalla.
 */
function renderDiploma(data){
  if(!data) return;
  const nameEl=document.getElementById('nombre');
  nameEl.textContent=data.nombre.toUpperCase();
  fitText(nameEl, document.querySelector('.name-underline').offsetWidth);
  document.getElementById('taller').textContent=data.taller;
  document.getElementById('facilitador').textContent=data.facilitador;
}

function fitText(el,width){
  let size=60;
  el.style.fontSize=size+'px';
  while(el.scrollWidth>width && size>12){
    size--;
    el.style.fontSize=size+'px';
  }
}

/**
 * Genera un PDF del diploma visible.
 */
async function downloadPDF(data){
  const diploma=document.getElementById('diploma');
  const canvas=await html2canvas(diploma,{scale:2});
  const img=canvas.toDataURL('image/png');
  const pdf=new jspdf.jsPDF('p','mm','a4');
  pdf.addImage(img,'PNG',0,0,210,297);
  pdf.save(`Diploma_${sanitize(data.nombre)}.pdf`);
}

/**
 * Genera PDFs de todos los participantes.
 */
async function downloadAll(){
  for(let i=0;i<participants.length;i++){
    renderDiploma(participants[i]);
    await new Promise(r=>setTimeout(r,100));
    await downloadPDF(participants[i]);
  }
}

/**
 * Limpia nombres de archivo.
 */
function sanitize(str){
  return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'_').replace(/[^A-Za-z0-9_]/g,'');
}
</script>
</body>
</html>
