<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Diplomas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="fonts/ffnort/stylesheet.css">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" onerror="libError('xlsx')"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="libError('jsPDF')"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" onerror="libError('html2canvas')"></script>
</head>
<body>
  <main class="container">
    <h1>Generador de Diplomas</h1>

    <div class="controls">
      <label class="file-input">
        <span>Seleccionar archivo Excel</span>
        <input type="file" id="file-input" accept=".xlsx,.xls,.csv">
      </label>
      <div class="info"><span id="count">0</span> participantes cargados</div>
      <select id="row-select"></select>
      <button id="preview-btn">Previsualizar</button>
      <button id="pdf-btn">Generar PDF del seleccionado</button>
      <button id="all-btn">Generar TODOS</button>
      <div id="status" class="status"></div>
    </div>

    <div id="preview">
      <section id="diploma" class="diploma">
        <img src="simbolo.svg" alt="Logo" class="logo">
        <h2 class="title">Diploma</h2>
        <p class="subtitle">Otorgado a</p>
        <h3 id="nombre" class="name"></h3>
        <p class="course">Por completar el curso <span id="curso"></span></p>
        <p class="hours">Duración: <span id="horas"></span></p>
        <p class="area">Área: <span id="area"></span></p>
        <div class="footer">
          <span id="firmante" class="firmante"></span>
          <span id="fecha" class="fecha"></span>
        </div>
      </section>
    </div>
  </main>

<script>
function libError(name){
  document.getElementById('status').textContent = 'No se pudo cargar '+name+'. Revisa tu conexión a Internet.';
}

let participants=[];
let selectedIndex=0;

document.getElementById('file-input').addEventListener('change', e=>loadExcel(e.target.files[0]));
document.getElementById('preview-btn').addEventListener('click',()=>{
  selectedIndex = parseInt(document.getElementById('row-select').value)||0;
  renderDiploma(participants[selectedIndex]);
});
document.getElementById('pdf-btn').addEventListener('click',()=>{
  const data = participants[selectedIndex];
  if(data) downloadPDF(data);
});
document.getElementById('all-btn').addEventListener('click', downloadAll);

/**
 * Lee el archivo Excel y carga los participantes.
 */
async function loadExcel(file){
  if(!file){return;}
  if(file.size > 10*1024*1024){
    alert('El archivo supera 10MB');
    return;
  }
  const data = await file.arrayBuffer();
  const workbook = XLSX.read(data,{type:'array'});
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet,{defval:''});
  if(!rows.length){
    alert('El archivo Excel no contiene datos válidos');
    return;
  }
  const firstRow = rows[0];
  const map={};
  Object.keys(firstRow).forEach(k=>{map[k.toLowerCase()]=k;});
  if(!map['nombre']){
    alert('La columna "Nombre" es obligatoria');
    return;
  }
  participants = rows.map(r=>{
    const row={};
    for(const key in r){row[key.toLowerCase()] = r[key];}
    const nombre=row['nombre'];
    if(!nombre) return null;
    return {
      nombre:nombre,
      curso:row['curso']||'—',
      horas:row['horas']||'—',
      area:row['area']||'—',
      fecha:formatDate(row['fecha'])||'—',
      firmante:row['firmante']||'—'
    };
  }).filter(Boolean);
  document.getElementById('count').textContent=participants.length;
  const select=document.getElementById('row-select');
  select.innerHTML=participants.map((p,i)=>`<option value="${i}">${i+1} - ${p.nombre}</option>`).join('');
  selectedIndex=0;
  renderDiploma(participants[0]);
}

/**
 * Convierte fechas a DD/MM/AAAA si es posible.
 */
function formatDate(value){
  if(!value) return '';
  const date=new Date(value);
  if(!isNaN(date)) return date.toLocaleDateString('es-PE');
  return value;
}

/**
 * Renderiza el diploma en pantalla.
 */
function renderDiploma(data){
  if(!data) return;
  document.getElementById('nombre').textContent=data.nombre;
  document.getElementById('curso').textContent=data.curso;
  document.getElementById('horas').textContent=data.horas;
  document.getElementById('area').textContent=data.area;
  document.getElementById('fecha').textContent=data.fecha;
  document.getElementById('firmante').textContent=data.firmante;
}

/**
 * Genera un PDF del diploma visible.
 */
async function downloadPDF(data){
  const diploma=document.getElementById('diploma');
  const canvas=await html2canvas(diploma,{scale:2});
  const img=canvas.toDataURL('image/png');
  const pdf=new jspdf.jsPDF('p','mm','a4');
  pdf.addImage(img,'PNG',0,0,210,297);
  pdf.save(`Diploma_${sanitize(data.nombre)}.pdf`);
}

/**
 * Genera PDFs de todos los participantes.
 */
async function downloadAll(){
  for(let i=0;i<participants.length;i++){
    renderDiploma(participants[i]);
    await new Promise(r=>setTimeout(r,100));
    await downloadPDF(participants[i]);
  }
}

/**
 * Limpia nombres de archivo.
 */
function sanitize(str){
  return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'_').replace(/[^A-Za-z0-9_]/g,'');
}
</script>
</body>
</html>
